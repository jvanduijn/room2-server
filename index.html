<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta id="vp" name="viewport" content="width=device-width, initial-scale=1.0">
  <title>room_2 ‚Äì multiplayer</title>
  <style>
    /* Hide external site header (e.g. WordPress theme header) */
    header,
    .site-header {
      display: none !important;
    }

    /* General reset and centering */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue",
                   Helvetica, Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      user-select: none;
      overflow: hidden;
      background-color: #000;
      color: #000;
    }

    .everything {
      position: relative;
      width: 400px;
      height: 460px; /* extra room for buttons + popups */
    }

    /* Background behind everything */
    .background {
      position: fixed;
      top: 0;
      left: 0;
      width: 414px;
      height: 750px;
      background-size: cover;
      background-position: center;
      z-index: -1;
      background-image: url('https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/background1.png');
    }

    /* Map container */
    #map {
      position: relative;
      -webkit-tap-highlight-color: transparent;
      background-color: transparent;
      width: 400px;
      height: 400px;
      background-image: url('https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/laag1binnen.png');
      background-size: 400px;
      background-repeat: no-repeat;
      overflow: visible;
      background-position: 0 -3px;
      border: 2px solid #111;
      box-sizing: border-box;
      margin: 0 auto;
    }

    @media (max-width: 480px) {
      .everything {
        width: 360px;
        height: 430px;
      }
      #map {
        width: 360px;
        height: 360px;
        background-size: 360px;
      }
    }

    /* Rooms = invisible full-click areas */
    .room {
      position: absolute;
      background-color: transparent;
      border: 2px solid transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8em;
      color: #555;
      text-align: center;
      cursor: pointer;
      opacity: 1;
      transition: transform 0.28s ease-in-out, opacity 0.28s ease-in-out;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      z-index: 1;
    }

    .room.active {
      transform: scale(1.01);
      z-index: 4;
      opacity: 1;
    }

    .room-label {
      display: none;
    }

    /* Player (red character ‚Äì local client) */
    .player {
      width: 20px;
      height: 36px;
      z-index: 999;
      background:
        url('https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/poppetje1Tekengebied%201%404x.png')
        no-repeat center center / contain;
      position: absolute;
      display: block;
      transition: transform 0.40s cubic-bezier(0.25, 0.1, 0.25, 1);
      will-change: transform;
      -webkit-tap-highlight-color: transparent;
      pointer-events: none;
    }

    /* Host (blue character ‚Äì synchronized via server) */
    .random-object {
      width: 20px;
      height: 36px;
      background:
        url('https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/poppetje2Tekengebied%201%404x.png')
        no-repeat center center / contain;
      position: absolute;
      cursor: pointer;
      z-index: 1001;
      transition: transform 0.40s cubic-bezier(0.25, 0.1, 0.25, 1);
    }

    /* Phone: characters 15% bigger */
    @media (max-width: 480px) {
      .player,
      .random-object {
        width: 23px;
        height: 41px;
      }
    }

    /* Inline icons for text popups */
    .host-icon-inline,
    .player-icon-inline {
      display: inline-block;
      width: 14px;
      height: 26px;
      background-size: contain;
      background-repeat: no-repeat;
      vertical-align: middle;
      margin-right: 4px;
    }
    .host-icon-inline {
      background-image: url('https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/poppetje2Tekengebied%201%404x.png');
    }
    .player-icon-inline {
      background-image: url('https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/poppetje1Tekengebied%201%404x.png');
    }

    /* Doors */
    .door {
      position: absolute;
      background-color: #111;
      border: 1px solid #111;
      cursor: pointer;
      z-index: 2;
      transition: background-color 0.15s ease, transform 0.10s ease;
      pointer-events: none;
      -webkit-tap-highlight-color: transparent;
    }
    .door-horizontal {
      width: 40px;
      height: 9px;
    }
    .door-vertical {
      width: 9px;
      height: 40px;
    }
    .door:hover {
      background-color: #00ff66;
      transform: scale(1.03);
    }

    .door-popup {
      display: none; /* we no longer show hover popups */
    }

    .clickable-region {
      position: absolute;
      cursor: pointer;
    }

    /* Top message popup: used for host actions (sleep, tv, etc.) */
    .top-message {
      position: fixed;
      top: 8%;
      left: 50%;
      transform: translateX(-50%);
      background-color: #e4ff3f;
      color: #020202;
      padding: 8px 14px;
      border: 2px solid #020202;
      font-size: 15px; /* ~20% bigger than earlier */
      letter-spacing: 0.04em;
      text-transform: uppercase;
      display: none;
      z-index: 2000;
      box-shadow: 0 0 0 2px #000;
    }

    /* Conversation prompt: '............?' */
    .conversation-prompt {
      position: fixed;
      top: 5%;
      left: 50%;
      transform: translateX(-50%);
      background-color: #fff;
      color: #0033ff;
      padding: 10px 18px;
      border: 2px solid #0033ff;
      font-size: 20px; /* 10% bigger */
      letter-spacing: 0.3em;
      display: none;
      z-index: 2100;
      box-shadow: 0 0 0 2px #000;
    }

    /* Conversation reply shown to host */
    .conversation-reply {
      position: fixed;
      top: 14%;
      left: 50%;
      transform: translateX(-50%);
      background-color: #ffffff;
      color: #111;
      padding: 8px 14px;
      border: 2px solid #ff2555;
      font-size: 15px;
      display: none;
      z-index: 2100;
      box-shadow: 0 0 0 2px #000;
      max-width: 320px;
      text-align: left;
    }

    /* Object name / instruction box (green digital style) */
    .instruction-box {
      display: none;
      position: fixed;
      bottom: 12%;
      left: 50%;
      transform: translateX(-50%);
      background-color: #ffffff;
      color: #00b83f;
      padding: 6px 10px;
      border: 2px solid #00b83f;
      font-size: 14px;
      text-align: center;
      z-index: 1005;
      max-width: 320px;
      letter-spacing: 0.05em;
      box-shadow: 0 0 0 2px #000;
    }

    @media (max-width: 768px) {
      .instruction-box {
        bottom: 14%;
      }
    }

    /* ? above host when conversation is active */
    .host-question {
      position: absolute;
      width: 20px;
      height: 20px;
      background-color: #e4ff3f;
      color: #0033ff;
      border: 2px solid #0033ff;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 13px; /* slightly smaller */
      font-weight: 600;
      box-shadow: 0 0 0 2px #000;
      pointer-events: none;
    }

    /* Action buttons (host only) */
    .action-panel {
      position: absolute;
      bottom: -46px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-wrap: nowrap;
      gap: 4px;
      z-index: 1200;
    }

    .action-btn {
      width: 38px;
      height: 32px;
      border-radius: 0;
      border: 2px solid #111;
      background-color: #111;
      color: #e4ff3f;
      font-size: 14px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }

    .action-btn span.key {
      font-size: 11px;
      margin-left: 2px;
    }

    .action-btn.active {
      background-color: #e4ff3f;
      color: #111;
      box-shadow: 0 0 0 2px #e4ff3f;
    }

    /* Rooms layout */
    .room1 { top: 9px;   left: 9px;   width: 72px;  height: 170px; }
    .room2 { top: 37px;  left: 90px;  width: 220px; height: 143px; }
    .room3 { top: 139px; left: 319px; width: 72px;  height: 131px; }
    .room4 { top: 188px; left: 9px;   width: 72px;  height: 81px;  }
    .room5 { top: 188px; left: 90px;  width: 159px; height: 81px;  }
    .room6 { top: 188px; left: 257px; width: 54px;  height: 81px;  }
    .room7 { top: 278px; left: 257px; width: 134px; height: 90px;  }

    /* Door positions (no more outside room) */
    .room1 .door1 { left: 68%; bottom: -12px; transform: translateX(-50%); }
    .room1 .door2 { right: -13px; top: 59%; transform: translateY(-50%); }

    .room2 .door1 { left: -11px; top: 50%; transform: translateY(-50%); } /* to room1 */
    .room2 .door2 { right: -11px; top: 50%; transform: translateY(-50%); }/* to room3 */
    .room2 .door3 { bottom: -12px; left: 59%; transform: translateX(-50%); }/* to room5 */
    .room2 .door4 { bottom: -12px; left: 89%; transform: translateX(-50%); }/* to room6 */

    .room3 .door1 { left: -13px; top: 69%; transform: translateY(-50%); } /* to room2 */
    .room3 .door3 { top: -12px; left: 50%; transform: translateX(-50%); } /* to room6 */

    .room4 .door1 { left: 68%; top: -12px; transform: translateX(-50%); } /* to room1 */
    .room4 .door2 { right: -13px; top: 30%; transform: translateY(-50%); }/* to room5 */

    .room5 .door1 { left: -13px; top: 30%; transform: translateY(-50%); } /* to room4 */
    .room5 .door2 { right: -13px; top: 30%; transform: translateY(-50%); }/* to room6 */
    .room5 .door3 { top: -11px; left: 82%; transform: translateX(-50%); } /* to room2 */

    .room6 .door1 { left: -13px; top: 30%; transform: translateY(-50%); } /* to room5 */
    .room6 .door2 { bottom: -12px; left: 50%; transform: translateX(-50%); }/* to room7 */
    .room6 .door3 { right: -12px; top: 50%; transform: translateY(-50%); }/* to room3 */
    .room6 .door4 { top: -12px; left: 50%; transform: translateX(-50%); } /* to room2 */

    .room7 .door1 { top: -12px; left: 19%; transform: translateX(-50%); } /* to room6 */

  </style>
</head>
<body>
<div class="background"></div>

<div class="everything">
  <div id="instructionBox" class="instruction-box"></div>

  <!-- Top info popups -->
  <div id="topMessage" class="top-message"></div>
  <div id="conversationPrompt" class="conversation-prompt">............?</div>
  <div id="conversationReply" class="conversation-reply"></div>

  <!-- MAP -->
  <div id="map">
    <!-- local player (red) -->
    <div id="player" class="player"></div>
    <!-- host (blue) -->
    <div id="host" class="random-object"></div>
    <!-- ? marker above host when asking something -->
    <div id="hostQuestion" class="host-question">?</div>

    <!-- ROOM 1 -->
    <div id="room1" class="room room1">
      <div class="room-label"></div>
      <div class="door door1 door-horizontal" data-target="room4"></div>
      <div class="door door2 door-vertical" data-target="room2"></div>

      <div class="clickable-region"
           style="left: 5px; top: 3px; width: 55px; height: 50px;"
           onclick="if(currentRoom==='room1'){playClickSound(); showObjectPopup('Virtual trees'); playSound('https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/trees1.mp3');}">
      </div>
      <div class="clickable-region"
           style="left: 3px; bottom: 3px; width: 55px; height: 45px;"
           onclick="if(currentRoom==='room1'){playClickSound(); showObjectPopup('Virtual trees'); playSound('https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/trees1.mp3');}">
      </div>
    </div>

    <!-- ROOM 2 ‚Äì computer lab -->
    <div id="room2" class="room room2">
      <div class="room-label"></div>
      <div class="door door1 door-vertical" data-target="room1"></div>
      <div class="door door2 door-vertical" data-target="room3"></div>
      <div class="door door3 door-horizontal" data-target="room5"></div>
      <div class="door door4 door-horizontal" data-target="room6"></div>

      <div class="clickable-region"
           style="left: 98px; top: 5px; width: 38px; height: 30px;"
           onclick="if(currentRoom==='room2'){playClickSound(); showObjectPopup('Computer'); playSound('https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/computersound2.mp3');}">
      </div>
      <div class="clickable-region"
           style="left: 94px; top: 105px; width: 25px; height: 27px;"
           onclick="if(currentRoom==='room2'){playClickSound(); showObjectPopup('3D printer'); playSound('https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/3dprinter3.mp3');}">
      </div>
      <div class="clickable-region"
           style="right: 23px; bottom: 7px; width: 63px; height: 58px;"
           onclick="if(currentRoom==='room2'){playClickSound(); showObjectPopup('Hologram area'); playSound('https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/hologram1.mp3');}">
      </div>
      <div class="clickable-region"
           style="right: 3px; top: 3px; width: 60px; height: 46px;"
           onclick="if(currentRoom==='room2'){playClickSound(); showObjectPopup('Book case'); playSound('https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/bookcase1.mp3');}">
      </div>
      <div class="clickable-region"
           style="left: 3px; top: 3px; width: 80px; height: 46px;"
           onclick="if(currentRoom==='room2'){playClickSound(); showObjectPopup('Server rack'); playSound('https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/serversound1.mp3');}">
      </div>
      <div class="clickable-region"
           style="left: 3px; bottom: 3px; width: 80px; height: 46px;"
           onclick="if(currentRoom==='room2'){playClickSound(); showObjectPopup('Server rack'); playSound('https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/serversound1.mp3');}">
      </div>
    </div>

    <!-- ROOM 3 ‚Äì kitchen -->
    <div id="room3" class="room room3">
      <div class="room-label"></div>
      <div class="door door1 door-vertical" data-target="room2"></div>
      <div class="door door3 door-horizontal" data-target="room6"></div>

      <div class="clickable-region"
           style="left: 10px; top: 11px; width: 43px; height: 65px;"
           onclick="if(currentRoom==='room3'){playClickSound(); showObjectPopup('Dinner table'); playSound('https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/diningtable1.mp3');}">
      </div>
      <div class="clickable-region"
           style="left: 8px; bottom: 1px; width: 13px; height: 11px;"
           onclick="if(currentRoom==='room3'){playClickSound(); showObjectPopup('Stove'); playSound('https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/stove1.mp3');}">
      </div>
      <div class="clickable-region"
           style="left: 34px; bottom: 1px; width: 14px; height: 11px;"
           onclick="if(currentRoom==='room3'){playClickSound(); showObjectPopup('Sink'); playSound('https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/loudsink1.mp3');}">
      </div>
    </div>

    <!-- ROOM 4 ‚Äì bathroom -->
    <div id="room4" class="room room4">
      <div class="room-label"></div>
      <div class="door door1 door-horizontal" data-target="room1"></div>
      <div class="door door2 door-vertical" data-target="room5"></div>

      <div class="clickable-region"
           style="left: 0px; top: 0px; width: 24px; height: 24px;"
           onclick="if(currentRoom==='room4'){playClickSound(); showObjectPopup('Shower'); playSound('https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/douche.mp3');}">
      </div>
      <div class="clickable-region"
           style="left: 21px; top: 62px; width: 14px; height: 15px;"
           onclick="if(currentRoom==='room4'){playClickSound(); showObjectPopup('Sink'); playSound('https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/sink1.mp3');}">
      </div>
      <div class="clickable-region"
           style="left: 0px; top: 33px; width: 8px; height: 22px;"
           onclick="if(currentRoom==='room4'){playClickSound(); showObjectPopup('Double sink'); playSound('https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/washinghands1.mp3');}">
      </div>
      <div class="clickable-region"
           style="right: 0px; top: 45px; width: 8px; height: 25px;"
           onclick="if(currentRoom==='room4'){playClickSound(); showObjectPopup('Cabinet'); playSound('https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/cabinclick.mp3');}">
      </div>
    </div>

    <!-- ROOM 5 ‚Äì living -->
    <div id="room5" class="room room5">
      <div class="room-label"></div>
      <div class="door door1 door-vertical" data-target="room4"></div>
      <div class="door door2 door-vertical" data-target="room6"></div>
      <div class="door door3 door-horizontal" data-target="room2"></div>

      <div class="clickable-region"
           style="left: 94px; top: 25px; width: 55px; height: 45px;"
           onclick="if(currentRoom==='room5'){playClickSound(); showObjectPopup('Grand piano');}">
      </div>
      <div class="clickable-region"
           style="left: 24px; top: 2px; width: 34px; height: 8px;"
           onclick="if(currentRoom==='room5'){playClickSound(); showObjectPopup('TV'); playSound('https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/tvbutton1.mp3');}">
      </div>
      <div class="clickable-region"
           style="left: 5px; bottom: 2px; width: 34px; height: 34px;"
           onclick="if(currentRoom==='room5'){playClickSound(); showObjectPopup('Couch');}">
      </div>
      <div class="clickable-region"
           style="left: 70px; bottom: 1px; width: 20px; height: 10px;"
           onclick="if(currentRoom==='room5'){playClickSound(); showObjectPopup('Doormat');}">
      </div>
    </div>

    <!-- ROOM 6 ‚Äì hall -->
    <div id="room6" class="room room6">
      <div class="room-label"></div>
      <div class="door door1 door-vertical" data-target="room5"></div>
      <div class="door door2 door-horizontal" data-target="room7"></div>
      <div class="door door3 door-vertical" data-target="room3"></div>
      <div class="door door4 door-horizontal" data-target="room2"></div>
    </div>

    <!-- ROOM 7 ‚Äì bedroom -->
    <div id="room7" class="room room7">
      <div class="room-label"></div>
      <div class="door door1 door-horizontal" data-target="room6"></div>

      <div class="clickable-region"
           style="left: 75px; top: 19px; width: 55px; height: 47px;"
           onclick="if(currentRoom==='room7'){playClickSound(); showObjectPopup('Bed'); playSound('https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/bed2.mp3');}">
      </div>
    </div>

    <!-- ACTION BUTTON PANEL (host only; JS will hide for players) -->
    <div id="actionPanel" class="action-panel">
      <button class="action-btn" id="btn-z" data-key="z">üò¥<span class="key">Z</span></button>
      <button class="action-btn" id="btn-t" data-key="t">üçΩ<span class="key">T</span></button>
      <button class="action-btn" id="btn-p" data-key="p">üéπ<span class="key">P</span></button>
      <button class="action-btn" id="btn-w" data-key="w">üå±<span class="key">W</span></button>
      <button class="action-btn" id="btn-s" data-key="s">üöø<span class="key">S</span></button>
      <button class="action-btn" id="btn-b" data-key="b">ü™•<span class="key">B</span></button>
      <button class="action-btn" id="btn-d" data-key="d">üç≥<span class="key">D</span></button>
      <button class="action-btn" id="btn-1" data-key="1">üì∫<span class="key">1</span></button>
      <button class="action-btn" id="btn-0" data-key="0">‚èπ<span class="key">0</span></button>
    </div>

  </div><!-- /map -->
</div>

<!-- Socket.IO client -->
<script src="https://cdn.socket.io/4.4.0/socket.io.min.js"></script>
<script>
  const isHost = window.location.search.includes('host=1');
  const socket = io();

  let currentRoom = 'room2';
  let hostRoom    = 'room2';
  let currentAudio = null;
  let tvAudio = null;

  const CONVERSATION_WINDOW_MS = 9000;   // players have ~9s to react
  const REPLY_DISPLAY_MS       = 4500;   // reply / no-response visible a bit longer

  let hostConversationActive = false;
  let conversationTimer = null;
  let collectedReactions = [];

  const roomGraph = {
    room1: ['room2','room4'],
    room2: ['room1','room3','room5','room6'],
    room3: ['room2','room6'],
    room4: ['room1','room5'],
    room5: ['room2','room4','room6'],
    room6: ['room2','room3','room5','room7'],
    room7: ['room6']
  };

  const mapEl          = document.getElementById('map');
  const playerEl       = document.getElementById('player');
  const hostEl         = document.getElementById('host');
  const hostQuestionEl = document.getElementById('hostQuestion');
  const instructionBox = document.getElementById('instructionBox');
  const topMessageEl   = document.getElementById('topMessage');
  const convPromptEl   = document.getElementById('conversationPrompt');
  const convReplyEl    = document.getElementById('conversationReply');
  const actionPanel    = document.getElementById('actionPanel');

  // ---- SOUND HELPERS ----
  const roomMoveSounds = [
    // replace / add your own
    'https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/footstep1.mp3',
    'https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/footstep2.mp3',
    'https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/footstep3.mp3',
    'https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/footstep4.mp3',
    'https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/footstep5.mp3'
  ];

  const clickSounds = [
    'https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/cabinclick.mp3'
  ];

  const messageReceivedSounds = [
    // put your custom message sounds here
    'https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/tvbutton1.mp3'
  ];

  const sleepSounds = [
    'https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/sleep1.mp3',
    'https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/sleep2.mp3',
    'https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/sleep3.mp3',
    'https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/sleep4.mp3',
    'https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/sleep5.mp3'
  ];

  const tableSounds = [
    'https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/table1.mp3',
    'https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/table2.mp3',
    'https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/table3.mp3',
    'https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/table4.mp3',
    'https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/table5.mp3'
  ];

  const pianoSounds = [
    'https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/satie.mp3'
  ];

  const waterSounds = [
    'https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/water1.mp3',
    'https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/water2.mp3',
    'https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/water3.mp3',
    'https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/water4.mp3',
    'https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/water5.mp3'
  ];

  const showerSounds = [
    'https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/douche.mp3',
    'https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/douche.mp3',
    'https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/douche.mp3',
    'https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/douche.mp3',
    'https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/douche.mp3'
  ];

  const brushSounds = [
    'https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/brush1.mp3',
    'https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/brush2.mp3',
    'https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/brush3.mp3',
    'https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/brush4.mp3',
    'https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/brush5.mp3'
  ];

  const dinnerSounds = [
    'https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/dinner1.mp3',
    'https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/dinner2.mp3',
    'https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/dinner3.mp3',
    'https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/dinner4.mp3',
    'https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/dinner5.mp3'
  ];

  const tvLoopSounds = [
    'https://pub-e2eda233e65d46ef9ded8e7546600fc3.r2.dev/tvroom.wav'
  ];

  function playSound(url, loop = false) {
    if (!url) return;
    try {
      if (currentAudio && !loop) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
      }
      const audio = new Audio(url);
      audio.loop = !!loop;
      audio.play().catch(() => {});
      if (!loop) currentAudio = audio;
      return audio;
    } catch (e) {
      console.error(e);
    }
  }

  function playRandom(list, loop = false) {
    if (!list || !list.length) return;
    const pick = list[Math.floor(Math.random() * list.length)];
    return playSound(pick, loop);
  }

  function playClickSound() {
    playRandom(clickSounds);
  }

  function playRoomMoveSound() {
    playRandom(roomMoveSounds);
  }

  function showObjectPopup(text) {
    instructionBox.textContent = text;
    instructionBox.style.display = 'block';
    clearTimeout(showObjectPopup._timeout);
    showObjectPopup._timeout = setTimeout(() => {
      instructionBox.style.display = 'none';
    }, 2000);
  }

  function showTopMessage(html) {
    topMessageEl.innerHTML = html;
    topMessageEl.style.display = 'block';
    clearTimeout(showTopMessage._timeout);
    showTopMessage._timeout = setTimeout(() => {
      topMessageEl.style.display = 'none';
    }, 2200);
  }

  // --- POSITIONING ---

  function moveElementToRoom(el, roomId, withSound = false) {
    const room = document.getElementById(roomId);
    if (!room || !el) return;

    const mapRect  = mapEl.getBoundingClientRect();
    const roomRect = room.getBoundingClientRect();

    const x = roomRect.left - mapRect.left + roomRect.width / 2 - el.offsetWidth / 2;
    const y = roomRect.top  - mapRect.top  + roomRect.height / 2 - el.offsetHeight / 2;

    el.style.transform = `translate3d(${x}px, ${y}px, 0)`;
    if (withSound) playRoomMoveSound();

    if (el === hostEl) {
      positionHostQuestion();
    }
  }

  function updateActiveRoom(roomId) {
    document.querySelectorAll('.room').forEach(r => {
      r.classList.toggle('active', r.id === roomId);
    });

    document.querySelectorAll('.door').forEach(d => d.style.pointerEvents = 'none');
    const room = document.getElementById(roomId);
    room.querySelectorAll('.door').forEach(d => d.style.pointerEvents = 'auto');
  }

  function goToRoom(targetRoom, fromHost = isHost) {
    if (targetRoom === currentRoom) return;
    if (!roomGraph[currentRoom] || !roomGraph[currentRoom].includes(targetRoom)) return;

    currentRoom = targetRoom;
    updateActiveRoom(currentRoom);

    if (fromHost) {
      hostRoom = currentRoom;
      moveElementToRoom(hostEl, hostRoom, true);
      socket.emit('hostMove', { roomId: hostRoom });
    } else {
      moveElementToRoom(playerEl, currentRoom, true);
    }
  }

  // position ? above host
  function positionHostQuestion() {
    if (!hostConversationActive) {
      hostQuestionEl.style.display = 'none';
      return;
    }
    const hostRect = hostEl.getBoundingClientRect();
    const mapRect  = mapEl.getBoundingClientRect();
    const x = hostRect.left - mapRect.left + hostRect.width / 2;
    const y = hostRect.top  - mapRect.top - 24; // slightly higher
    hostQuestionEl.style.transform = `translate3d(${x}px, ${y}px, 0)`;
    hostQuestionEl.style.display = 'flex';
  }

  window.addEventListener('resize', () => {
    moveElementToRoom(isHost ? hostEl : playerEl, currentRoom);
    positionHostQuestion();
  });

  // --- SOCKET SETUP ---

  socket.on('connect', () => {
    socket.emit('join', { role: isHost ? 'host' : 'player' });
  });

  if (!isHost) {
    socket.on('hostPosition', (data) => {
      if (!data || !data.roomId) return;
      hostRoom = data.roomId;
      moveElementToRoom(hostEl, hostRoom);
    });
  }

  socket.on('initialHostPosition', (data) => {
    if (!isHost) return;
    if (data && data.roomId) {
      hostRoom = data.roomId;
      currentRoom = hostRoom;
      updateActiveRoom(currentRoom);
      moveElementToRoom(hostEl, hostRoom);
    }
  });

  // Host actions mirrored to players (popups only; sound only on host)
  socket.on('hostAction', (payload) => {
    if (isHost) return;
    if (!payload || !payload.messageHtml) return;
    showTopMessage(payload.messageHtml);
  });

  // Conversation events
  socket.on('conversationPrompt', () => {
    convPromptEl.style.display = 'block';
    hostConversationActive = true;
    positionHostQuestion();
    // players can type right away
  });

  socket.on('conversationEnd', () => {
    convPromptEl.style.display = 'none';
    hostConversationActive = false;
    positionHostQuestion();
  });

  socket.on('conversationResult', (data) => {
    if (!data || !data.text) {
      if (!isHost) return;
      convReplyEl.textContent = 'no response this time';
    } else {
      if (!isHost) return;
      // [red icon: "message"]
      convReplyEl.innerHTML =
        '<span class="player-icon-inline"></span>' +
        '‚Äú' + escapeHtml(data.text) + '‚Äù';
      playRandom(messageReceivedSounds);
    }

    convReplyEl.style.display = 'block';
    clearTimeout(socket._replyTimer);
    socket._replyTimer = setTimeout(() => {
      convReplyEl.style.display = 'none';
    }, REPLY_DISPLAY_MS);
  });

  // --- ACTION BUTTON LOGIC (HOST) ---

  const actionMap = {
    z: {
      buttonId: 'btn-z',
      sounds: sleepSounds,
      messageHtml: '<span class="host-icon-inline"></span>is sleeping‚Ä¶'
    },
    t: {
      buttonId: 'btn-t',
      sounds: tableSounds,
      messageHtml: '<span class="host-icon-inline"></span>is dressing the table‚Ä¶'
    },
    p: {
      buttonId: 'btn-p',
      sounds: pianoSounds,
      messageHtml: '<span class="host-icon-inline"></span>is playing the piano‚Ä¶'
    },
    w: {
      buttonId: 'btn-w',
      sounds: waterSounds,
      messageHtml: '<span class="host-icon-inline"></span>is watering a tree‚Ä¶'
    },
    s: {
      buttonId: 'btn-s',
      sounds: showerSounds,
      messageHtml: '<span class="host-icon-inline"></span>is taking a shower‚Ä¶'
    },
    b: {
      buttonId: 'btn-b',
      sounds: brushSounds,
      messageHtml: '<span class="host-icon-inline"></span>is brushing teeth‚Ä¶'
    },
    d: {
      buttonId: 'btn-d',
      sounds: dinnerSounds,
      messageHtml: '<span class="host-icon-inline"></span>is making dinner‚Ä¶'
    },
    '1': {
      buttonId: 'btn-1',
      tvOn: true,
      messageHtml: '<span class="host-icon-inline"></span>turned the TV on‚Ä¶'
    },
    '0': {
      buttonId: 'btn-0',
      tvOff: true,
      messageHtml: '<span class="host-icon-inline"></span>turned the TV off‚Ä¶'
    }
  };

  function triggerHostAction(key) {
    if (!isHost) return;
    const a = actionMap[key];
    if (!a) return;

    // Visual state
    document.querySelectorAll('.action-btn').forEach(b => b.classList.remove('active'));
    const btn = a.buttonId ? document.getElementById(a.buttonId) : null;
    if (btn) btn.classList.add('active');
    setTimeout(() => { if (btn) btn.classList.remove('active'); }, 250);

    // Audio
    if (a.tvOn) {
      if (tvAudio) { tvAudio.pause(); tvAudio = null; }
      tvAudio = playRandom(tvLoopSounds, true);
    } else if (a.tvOff) {
      if (tvAudio) { tvAudio.pause(); tvAudio = null; }
    } else {
      playRandom(a.sounds);
    }

    // Message (host + players)
    const html = a.messageHtml;
    showTopMessage(html);
    socket.emit('hostAction', { messageHtml: html });
  }

  // Command buttons click (host only)
  document.querySelectorAll('.action-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      if (!isHost) return;
      const key = btn.dataset.key;
      triggerHostAction(key);
    });
  });

  // --- HOST / PLAYER CONTROLS ---

  // Host click: only players can click host for small bump + click sound
  hostEl.addEventListener('click', () => {
    if (isHost) return;
    if (currentRoom !== hostRoom) return;

    playClickSound();

    const original = hostEl.style.transform || '';
    hostEl.style.transform = original + ' scale(1.1)';
    setTimeout(() => {
      hostEl.style.transform = original;
    }, 50);
  });

  // Doors for navigation
  document.querySelectorAll('.door').forEach(door => {
    const target = door.dataset.target;
    door.addEventListener('click', (e) => {
      e.stopPropagation();
      if (!target) return;
      goToRoom(target, isHost);
    });
  });

  // Full room clickability
  document.querySelectorAll('.room').forEach(room => {
    room.addEventListener('click', () => {
      goToRoom(room.id, isHost);
    });
  });

  // Keyboard controls
  window.addEventListener('keydown', (e) => {
    const key = e.key.toLowerCase();

    // Arrow keys for host movement
    if (isHost) {
      if (['arrowup','arrowdown','arrowleft','arrowright'].includes(e.key.toLowerCase())) {
        const neighbors = roomGraph[currentRoom] || [];
        if (neighbors.length) {
          const target = neighbors[Math.floor(Math.random() * neighbors.length)];
          goToRoom(target, true);
        }
        return;
      }
    }

    // Conversation start (host presses '2')
    if (isHost && e.key === '2') {
      if (hostConversationActive) return;
      hostConversationActive = true;
      convPromptEl.style.display = 'block';
      positionHostQuestion();
      collectedReactions = [];
      socket.emit('startConversation');
      if (conversationTimer) clearTimeout(conversationTimer);
      conversationTimer = setTimeout(() => {
        hostConversationActive = false;
        convPromptEl.style.display = 'none';
        positionHostQuestion();
        socket.emit('endConversation');
      }, CONVERSATION_WINDOW_MS);
      return;
    }

    // Player sends reaction during active window
    if (!isHost && hostConversationActive && e.key === 'Enter') {
      const msg = prompt('type a reaction');
      if (msg && msg.trim()) {
        socket.emit('submitReaction', { text: msg.trim() });
      }
      return;
    }

    // Host action keys
    if (isHost && actionMap[key]) {
      triggerHostAction(key);
    }
  });

  // Hide action panel completely for players (also on phone)
  if (!isHost && actionPanel) {
    actionPanel.style.display = 'none';
  }

  // --- INIT LAYOUT ---

  window.addEventListener('load', () => {
    if (isHost) {
      playerEl.style.display = 'none';
      currentRoom = hostRoom;
      updateActiveRoom(currentRoom);
      moveElementToRoom(hostEl, hostRoom);
    } else {
      hostRoom = 'room2';
      currentRoom = 'room2';
      updateActiveRoom(currentRoom);
      moveElementToRoom(playerEl, currentRoom);
    }
  });

  // --- small helper ---
  function escapeHtml(str) {
    return str.replace(/[&<>"']/g, function(m) {
      return ({
        '&':'&amp;',
        '<':'&lt;',
        '>':'&gt;',
        '"':'&quot;',
        "'":'&#39;'
      })[m];
    });
  }
</script>
</body>
</html>
